<!-- GENS overview template -->
{% import 'info.html' as info %}

{% macro annotation_track(track_name) %}
    <div id="{{ track_name }}-container" class="track-container">
        <p class='track-xlabel'>{{ track_name | capitalize }}</p>
        <div id='{{ track_name }}-track-container' class='info-container' title='{{ track_name }}'>
            <canvas id='{{ track_name }}-content' class='info-canvas'></canvas>
            <canvas id='{{ track_name }}-draw' class='info-canvas offscreen'></canvas>
            <div id='{{ track_name }}-titles' class='info-titles'></div>
        </div>
    </div>
{% endmacro %}

{% extends "layout.html" %}
{% block title %}Visualization{% endblock title %}
{% block css_style %}
    {{ super() }}
    <link rel='stylesheet' href='{{ url_for('gens.static', filename='gens.min.css') }}' type='text/css'>
{% endblock css_style %}
{% block scripts %}
    <script src='{{ url_for('gens.static', filename='gens.min.js') }}'></script>
{% endblock scripts %}

{% macro loading() %}
    <div class="loading-view">
        <div class="loading-container">
            <p id="loading" class="message">Loading sample</p>
            <p id="printing" class="message" hidden>Preparing to print</p>
            <div class="spinner"></div>
        </div>
    </div>
{% endmacro %}

{% block body %}
<div id='main-container'>
    {{ loading() }}
    <div class="header">
        <div id='left-group'>
            <div id="logo-container">
                <span class='logo'></span>
            </div>
            <span class='version'>v{{ version }}</span>
            <span class='date'>{{todays_date}}</span>
        </div>
        <div id='center-group'>
            <span class='bold' title='Sample ID'>{{sample_name}}</span>
            <span class='version'>(Genome build: {{hg_type}})</span>
        </div>
        <div id='right-group'>
            <span class='header-icon print no-print'
                onclick='loadPrintPage(inputField.value);' title='Print'>
            </span>
            <span class='header-icon permalink no-print'
                onclick='copyPermalink("{{hg_type}}", inputField.value);' title='Copy permalink'>
            </span>
            <span class='header-icon no-print info'></span>
            {{ info.help_popup() }}
        </div>
    </div>

    <div id='visualization-container'>
        <div id='interactive-container'>
            <canvas id='interactive-content'></canvas>
            <canvas id='interactive-static'></canvas>
            <div id='interactive-marker' class='marker'></div>
            <div id='loading-div'>LOADING...</div>
        </div>

        {{ annotation_track("variant") }}
        {{ annotation_track("transcript") }}
        {{ annotation_track("annotation") }}

        <div id='button-container'>
            <select id='source-list'></select>
            <button onclick='ic.panTracksLeft();' class='button--pan no-print'>
                <span class='icon arrow-left' title='Left'></span>
            </button>
            <button onclick='ic.zoomIn();' class='button--zoom-in no-print'>
                <span class='icon search-plus' title='Zoom in'></span>
            </button>
            <button onclick='ic.zoomOut();' class='button--zoom-out no-print'>
                <span class='icon search-minus' title='Zoom out'></span>
            </button>
            <button onclick='ic.panTracksRight();' class='button--pan no-print'>
                <span class='icon arrow-right' title='Right'></span>
            </button>
            <form id='region_form'>
                <input onFocus='this.select();' id='region_field' type='text' size=20>
                <input type='submit' class='button button--submit no-print' title='Submit range'>
            </form>
        </div>

        <div id='overview-container'>
            <canvas id='overview-static'></canvas>
            <div class='marker' id='overview-marker'></div>
        </div>
    </div>
</div>
<script>
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    const _apiHost = 'api/';

    // Print page settings
    let printing = false;
    if ('{{print_page}}' == 'true') {
        printing = true;
        let mainContainer = document.querySelector('#main-container');
        mainContainer.style.width = '1122px';
        mainContainer.style.overflowY = 'hidden';
        let loading = document.querySelector('.loading-container');
        loading.querySelector("#loading").toggleAttribute("hidden")
        loading.querySelector("#printing").toggleAttribute("hidden")
    }

    // Listener values
    const inputField = document.getElementById('region_field');

    // Set first input field value for ic
    let start = {{ start }} == 0 ? 1 : {{ start }};
    inputField.value = '{{chrom}}' + ':' + start + '-' + {{end}};
    inputField.placeholder = inputField.value;

    // Hide non-rendered content
    window.onload = (event) => {
        document.getElementById('visualization-container').style.visibility = 'hidden';
    };

    // Setup functions to run when the data has finished loading
    document.addEventListener('data-loaded', () => {
        // hide loading
        document.querySelector('.loading-view')
                .toggleAttribute('hidden');
        // display grid containers
        document.querySelector('#visualization-container')
                .style.visibility = 'visible';
        document.querySelector('#visualization-container')
                .style.display = 'grid';
        // display printing
        if (printing == true) {
          printPage();
        }
    });

    // Initiate variant, annotation and transcript canvases
    // and pass flask values to tracks
    const {ic, oc, ac, tc, vc} = gens.initCanvases({
        sampleName: '{{ sample_name }}',
        hgType: {{ hg_type }},
        hgFileDir: '{{ hg_filedir }}',
        uiColors: {{ ui_colors | tojson | safe }},
        selectedVariant: '{{ selected_variant }}',
        annotationFile: '{{ annotation }}',
    })

    // Draw content
    Promise.all([
            ic.drawStaticContent(),
            ic.drawInteractiveContent(),
            vc.drawTrack(inputField.value),
            tc.drawTrack(inputField.value),
            oc.drawOverviewContent(printing),
        ]);

    // Redraw when new region is requested
    document.getElementById('region_form').addEventListener('submit',
        function (event) {
            const chromosomes = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10',
            '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21',
            '22', 'X', 'Y']
            event.preventDefault();
            // if input contains both : and -
            if (inputField.value.includes(':') &&
                inputField.value.includes(':')) {
                ic.redraw(inputField.value);
            } else if (chromosomes.includes(inputField.value)) {
                ic.redraw(`${inputField.value}:0-None`);
            } else {
                get('search-annotation', {query: inputField.value,
                                          hg_type: hgType})
                    .then( (result) => {
                        if ( result.status == 200 ) {
                            ic.redraw(`${result.chromosome}:${result.start_pos}-${result.end_pos}`)
                        }
                    });
            }
        });

</script>
{% endblock body %}
