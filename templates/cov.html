<!DOCTYPE html>
<html>
    <head>
		<meta charset=utf-8>
        <link rel="stylesheet" href="static/css/cov.css" type="text/css">
        <link rel="icon" href="data:,">
        <script src="{{ url_for('static', filename='js/jquery-3.1.1.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/three.min.js') }}"></script>
        <html>
            <div class="grid-container">
                <div id="interactive-container"></div>

                <div id="button-container">
                    <form id="region_form">
                        <input name="region" id='region_field' type="text" size=20>
                        <input type="submit">
                    </form>
                    <button onclick="left();">left</button>
                    <button onclick="right();">right</button>
                    <button onclick="zoomIn();">+</button>
                    <button onclick="zoomOut();">-</button>
                </div>

                <div id="overview-container">
                    <canvas id='overview-content'>
                    </canvas>
                    <canvas id='overview-text'>
                    </canvas>
                </div>
            </div>
        </html>
    </head>

    <body>
        <script type="text/javascript" src="{{ url_for('static', filename='js/cov.js')}}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='js/overview.js')}}"></script>

        <script>
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

            let logRMedian = {{median}};
            let title = "{{title}}";

            let callChrom = "{{call_chrom}}";
            let callStart = {{call_start}};
            let callEnd   = {{call_end}};

            var gc = new GeneCanvas(700, 300, "{{chrom}}", {{start}}, {{end}});
            var ctx = gc.dataCanvas.getContext("2d");

            <!-- OVERVIEW CANVAS -->

            <!-- let overviewWidth = 100; -->
            <!-- let overviewHeight = 400; -->
            <!-- let overviewNum = 0; -->

            <!-- let overviews = [overviewNum]; -->
            <!-- for (let i = 1; i <= overviewNum; i++) { -->
                <!-- overviews[i] = new OverviewCanvas(overviewWidth, overviewHeight, i); -->

                <!-- $.getJSON($SCRIPT_ROOT + '/_getcov', { -->
                    <!-- region: i + ":" + overviews[i].cvar.start + "-" + overviews[i].cvar.end, -->
                    <!-- median: logRMedian -->
                <!-- }, function(result) { -->
                    <!-- overviews[i].draw(result["data"], result["baf"]); -->
                <!-- }); -->
            <!-- } -->


            <!-- WEBGL OVERVIEW -->

            let width = $(document).innerWidth(), height = 800, near = 0.1, far = 100;
            let margin = 2;
            var scene = new THREE.Scene();
            var camera = new THREE.OrthographicCamera(width / -2, width / 2, height / -2, height / 2, near, far);

            // Set dimensions of overview canvases
            var canvas = document.getElementById('overview-content');
            var canvasText = document.getElementById('overview-text')
            canvas.width = width;
            canvas.height = height;
            canvasText.width = width;
            canvasText.height = height;

            var context = canvas.getContext('webgl2');
            var renderer = new THREE.WebGLRenderer({ canvas:canvas, context:context, antialiasing: true });

            var res_start = 0; // Start value for overview graph
            var res_end = 245000000; // End value for overview graph

            var baf_y_start = 1.0; // Start value for y axis
            var baf_y_end = 0.0; // End value for y axis
            var baf_step = 0.2; // Step value for drawing ticks along y-axis

            var logr_y_start = 4.0; // Start value for y axis
            var logr_y_end = -4.0; // End value for y axis
            var logr_step = 1.0; // Step value for drawing ticks along y-axis

            let x = margin * 2 + 20; // Y-position for first box
            let y = margin * 2; // X-position for first box
            let num_chrom = 22; // Number displayable chromosoms
            let title_margin = 10; // Margin between box and title
            let y_margin = 5; // margin for top and bottom in graph
            let x_margin = 2; // margin for x-axis in graph
            let row_margin = 30; // margin between rows
            let y_pos = y + row_margin; // Startpoint for variable y_pos after margin
            let chrom = 1; // First chromosome
            let box_width = 120; // Width of one box
            let box_height = 130; // Height of one box
            let xAmpl = (box_width - 2 * x_margin) / (res_end - res_start); // Amplitude for scaling x-axis to fill whole width
            let bafYAmpl = (box_height) / (baf_y_start - baf_y_end); // Amplitude for scaling y-axis to fill whole width
            let logrYAmpl = (box_height) / (logr_y_start - logr_y_end); // Amplitude for scaling y-axis to fill whole width

            while (chrom <= num_chrom) {
                // Fill row with graphs, start on new row when full
                for (let x_pos = x; (x_pos + box_width < $(document).innerWidth()) && (chrom <= num_chrom); x_pos += box_width) {
                    // Draw data
                    $.getJSON($SCRIPT_ROOT + '/_getoverviewcov', {
                        region: chrom + ":" + res_start + "-" + res_end,
                        median: logRMedian,
                        xpos: x_pos + x_margin,
                        ypos: y_pos,
                        boxHeight: box_height,
                        y_margin: y_margin,
                        x_ampl: xAmpl
                    }, function(result) {
                        // Draw chromosome title
                        drawText(result['x_pos'] - x_margin + box_width / 2,
                                result['y_pos'] - title_margin,
                                result['chrom'], 'center');

                        // Draw BAF
                        createOverviewGraph(scene, result['x_pos'] - x_margin,
                                result['y_pos'], box_width, box_height, y_margin,
                                baf_y_start, baf_y_end, baf_step);

                        // Draw LogR
                        createOverviewGraph(scene, result['x_pos'] - x_margin,
                                result['y_pos'] + box_height, box_width, box_height,
                                y_margin, logr_y_start, logr_y_end, logr_step);

                        // Plot scatter data
                        drawData(scene, result["baf"], '#FF0000');
                        drawData(scene, result["data"], '#000000');
                        renderer.render(scene, camera);
                    });
                    chrom++;
                }
                // Start on new row
                y_pos += 2 * box_height + row_margin;
            }

            // Only want to see fourth quadrant
            camera.position.x = width / 2 - margin;
            camera.position.y = height / 2 - margin;
            camera.position.z = 1;

            gc.draw({{data|safe}}, {{baf|safe}});


            <!-- LISTENERS -->

            var drag = false;
            var dragStart;
            var dragEnd;
            let input_field = document.getElementById('region_field');
            input_field.placeholder = gc.cvar.chromosome + ':' + gc.cvar.start + '-' + gc.cvar.end;

            document.getElementById('region_form').addEventListener('submit', function (event) {
                event.preventDefault();
                $.getJSON($SCRIPT_ROOT + '/_getcov', {
                    region: document.getElementById('region_field').value,
                    median: logRMedian
                }, function (result) {
                    gc.cvar.chromosome = result['chrom'];
                    gc.cvar.start = result['start'];
                    gc.cvar.end = result['end'];
                    gc.draw(result['data'], result['baf']);
                }).done(function () {
                    input_field.blur();
                }).fail(function () {
                    console.log("Bad input");
                    input_field.placeholder = 'Bad input: ' + input_field.value;
                    input_field.value = '';
                });
            });

            gc.dataCanvas.addEventListener('mousedown', function(event) {
                if (!gc.cvar.disallowDrag) {
                    dragStart = {
                        x: event.pageX - gc.dataCanvas.offsetLeft,
                        y: event.pageY - gc.dataCanvas.offsetTop
                    }
                    dragEnd = {
                        x: event.pageX - gc.dataCanvas.offsetLeft,
                        y: event.pageY - gc.dataCanvas.offsetTop
                    }
                    drag = true;
                }
            });

            gc.dataCanvas.addEventListener('mousemove', function(event) {
                if (drag && !gc.cvar.disallowDrag) {
                    dragEnd = {
                        x: event.pageX - gc.dataCanvas.offsetLeft,
                        y: event.pageY - gc.dataCanvas.offsetTop
                    }
                    ctx.clearRect(0, 0, gc.dataCanvas.width, gc.dataCanvas.height);
                    ctx.drawImage(gc.drawCanvas,
                                0,
                                0,
                                gc.drawCanvas.width,
                                gc.drawCanvas.height,
                                dragEnd.x - dragStart.x,
                                0,
                                gc.drawCanvas.width,
                                gc.drawCanvas.height);
                }
            });

            gc.dataCanvas.addEventListener('mouseup', function(event) {
                if (drag) {
                    drag = false;
                    let scale = gc.dataCanvas.width / (gc.cvar.end - gc.cvar.start);
                    let move_dist = Math.floor((dragStart.x - dragEnd.x) / scale);
                    if (gc.cvar.start + move_dist < 0 ) {
                        move_dist -= (gc.cvar.start + move_dist);
                    }
                    gc.cvar.start += move_dist;
                    gc.cvar.end += move_dist;
                    gc.cvar.disallowDrag = true;
                    redraw();
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                'use strict';

                const options = {
                    eventType: 'keydown',
                    keystrokeDelay: 1000
                };

                keyMapper(options);
            });
        </script>
    </body>
</html>
