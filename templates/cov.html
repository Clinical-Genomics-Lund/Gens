<!doctype html>
    <head>
        <link rel="stylesheet" href="static/css/cov.css" type="text/css">
        <script src="{{ url_for('static', filename='js/jquery-3.1.1.min.js') }}"></script>
    </head>

    <body>
        <div class="grid-container">
            <div id="interactive-container"></div>

            <div id="button-container">
                <form method="POST" id="region_form" action="{{url_for('coverage_view')}}">
                    <input name="region" id='region_field' type="text" size=20>
                    <input type="submit">
                </form>
                <button onclick="left();">left</button>
                <button onclick="right();">right</button>
                <button onclick="zoomIn();">+</button>
                <button onclick="zoomOut();">-</button>
            </div>

            <div id="overview-container"></div>
        </div>
        <script type="text/javascript" src="{{ url_for('static', filename='js/cov.js')}}"></script>

    </body>

    <script>
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

        let logRMedian = {{median}};
        let title = "{{title}}";

        let callChrom = "{{call_chrom}}";
        let callStart = {{call_start}};
        let callEnd   = {{call_end}};

        var gc = new GeneCanvas(700, 300, "{{chrom}}", {{start}}, {{end}});
        var ctx = gc.dataCanvas.getContext("2d");

        let overviewWidth = 100;
        let overviewHeight = 400;
        let overviewInterval = Math.floor(($(window).width() - overviewWidth) / overviewWidth);
        let overviewNum = 22;
        let overviewRows = Math.ceil(overviewNum / overviewInterval);

        for (let i = 1; i <= overviewRows; i++) {
            let overviewDiv = document.createElement('div');
            overviewDiv.id = 'overview-div' + i;
            overviewDiv.class = 'overview-div';
            document.getElementById('overview-container').appendChild(overviewDiv);
        }

        let overviews = [overviewNum];
        let divNum = 0;
        for (let i = 1; i <= overviewNum; i++) {
            if ((i - 1) % overviewInterval === 0 || i === 1) {
                divNum++;
                showYValues = true
            } else {
                showYValues = false
            }

            overviews[i] = new OverviewCanvas(overviewWidth, overviewHeight, i, showYValues, 'overview-div' + divNum);

            $.getJSON($SCRIPT_ROOT + '/_getcov', {
                region: i + ":" + overviews[i].cvar.start + "-" + overviews[i].cvar.end,
                median: logRMedian
            }, function(result) {
                overviews[i].draw(result["data"], result["baf"]);
            });
        }

        gc.draw({{data|safe}}, {{baf|safe}});

        var drag = false;
        var dragStart;
        var dragEnd;
        let input_field = document.getElementById('region_field');
        input_field.placeholder = gc.cvar.chromosome + ':' + gc.cvar.start + '-' + gc.cvar.end;

        gc.dataCanvas.addEventListener('mousedown', function(event) {
            if (!gc.cvar.disallowDrag) {
                dragStart = {
                    x: event.pageX - gc.dataCanvas.offsetLeft,
                    y: event.pageY - gc.dataCanvas.offsetTop
                }
                dragEnd = {
                    x: event.pageX - gc.dataCanvas.offsetLeft,
                    y: event.pageY - gc.dataCanvas.offsetTop
                }
                drag = true;
            }
        });

        gc.dataCanvas.addEventListener('mousemove', function(event) {
            if (drag && !gc.cvar.disallowDrag) {
                dragEnd = {
                    x: event.pageX - gc.dataCanvas.offsetLeft,
                    y: event.pageY - gc.dataCanvas.offsetTop
                }
                ctx.clearRect(0, 0, gc.dataCanvas.width, gc.dataCanvas.height);
                ctx.drawImage(gc.drawCanvas,
                              0,
                              0,
                              gc.drawCanvas.width,
                              gc.drawCanvas.height,
                              dragEnd.x - dragStart.x,
                              0,
                              gc.drawCanvas.width,
                              gc.drawCanvas.height);
            }
        });

        gc.dataCanvas.addEventListener('mouseup', function(event) {
            if (drag) {
                drag = false;
                let scale = gc.dataCanvas.width / (gc.cvar.end - gc.cvar.start);
                let move_dist = Math.floor((dragStart.x - dragEnd.x) / scale);
                if (gc.cvar.start + move_dist < 0 ) {
                    move_dist -= (gc.cvar.start + move_dist);
                }
                gc.cvar.start += move_dist;
                gc.cvar.end += move_dist;
                gc.cvar.disallowDrag = true;
                redraw();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            'use strict';

            const options = {
                eventType: 'keydown',
                keystrokeDelay: 1000
            };

            keyMapper(options);
        });
    </script>
</html>
