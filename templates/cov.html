<!doctype html>
    <head>
        <link rel="stylesheet" href="static/css/flexboxgrid.min.css" type="text/css">
        <link rel="stylesheet" href="static/css/cov.css" type="text/css">
        <script src="{{ url_for('static', filename='js/jquery-3.1.1.min.js') }}"></script>
    </head>

    <body>
        <div class="grid-container">
            <div id="interactive-container">
            </div>
            <div id="overview-container">
            </div>

            <div id="button-container">
                <form method="POST" id="region_form" action="{{url_for('coverage_view')}}">
                    <input name="region" type="text" size=20>
                    <input type="submit">
                </form>

                <button onclick="left();">left</button>
                <button onclick="right();">right</button>
                <button onclick="zoom_in();">+</button>
                <button onclick="zoom_out();">-</button>
            </div>
        </div>
        <script type="text/javascript" src="{{ url_for('static', filename='js/cov.js')}}"></script>

    </body>

    <script>
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

        let chrom = "{{chrom}}";
        let start = {{start}};
        let end   = {{end}};

        let chrom_start = 0;
        let chrom_end = 35460000;

        let call_chrom = "{{call_chrom}}";
        let call_start = {{call_start}};
        let call_end   = {{call_end}};

        var gc = new GeneCanvas(400, 300);
        var ctx = gc.dataCanvas.getContext("2d");

        let overviews = [5];
        for (let i = 1; i <= 5; i++) {
            overviews[i] = new OverviewCanvas(150, 400);
            $.getJSON($SCRIPT_ROOT + '/_getcov', {
                region: i + ":" + chrom_start + "-" + chrom_end,
            }, function(result) {
                draw_coverage(result["data"], result["baf"], overviews[i], i);
            }).done (function() { disallow_drag = false; });
        }

        draw_coverage({{data|safe}}, {{baf|safe}}, gc, chrom);

        var drag = false;
        var disallow_drag = false;
        var dragStart;
        var dragEnd;

        gc.dataCanvas.addEventListener('mousedown', function(event) {
            if (!disallow_drag) {
                dragStart = {
                    x: event.pageX - gc.dataCanvas.offsetLeft,
                    y: event.pageY - gc.dataCanvas.offsetTop
                }
                dragEnd = {
                    x: event.pageX - gc.dataCanvas.offsetLeft,
                    y: event.pageY - gc.dataCanvas.offsetTop
                }
                drag = true;
            }
        });

        gc.dataCanvas.addEventListener('mousemove', function(event) {
            if (drag && !disallow_drag) {
                dragEnd = {
                    x: event.pageX - gc.dataCanvas.offsetLeft,
                    y: event.pageY - gc.dataCanvas.offsetTop
                }
                ctx.clearRect(0, 0, gc.dataCanvas.width, gc.dataCanvas.height);
                ctx.drawImage(gc.drawCanvas,
                              0,
                              0,
                              gc.drawCanvas.width,
                              gc.drawCanvas.height,
                              dragEnd.x - dragStart.x,
                              0,
                              gc.drawCanvas.width,
                              gc.drawCanvas.height);
            }
        });

        gc.dataCanvas.addEventListener('mouseup', function(event) {
            if (drag) {
                drag = false;
                let scale = gc.dataCanvas.width / (end - start);
                let move_dist = Math.floor((dragStart.x - dragEnd.x) / scale);
                if (start + move_dist < 0 ) {
                    move_dist -= (start + move_dist);
                }
                start += move_dist;
                end += move_dist;
                disallow_drag = true;
                redraw();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            'use strict';

            const options = {
                eventType: 'keydown',
                keystrokeDelay: 1000
            };

            keyMapper(options);
        });
    </script>
</html>
