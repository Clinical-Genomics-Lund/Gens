<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <link rel='stylesheet' href='static/css/cov.css' type='text/css'>
        <link rel='icon' href='data:,'>
        <script src='{{ url_for('static', filename='js/jquery-3.1.1.min.js') }}'></script>
        <script src='{{ url_for('static', filename='js/three.min.js') }}'></script>
        <html>
            <div id='progress-container'>
                <progress value="0" max="1" id='progress-bar'></progress>
            </div>

            <div id='grid-container'>
                <div id='annotation-overlays'></div>

                <div id='annotation-container'>
                    <canvas id='annotation'></canvas>
                </div>

                <div id='visualization-container'>
                    <div id='interactive-container'>
                        <canvas id='interactive-content'></canvas>
                        <canvas id='interactive-static'></canvas>
                    </div>

                    <div id='track-container' class='info-container'>
                        <canvas id='track-canvas' class='info-canvas'></canvas>
                        <div id='track-titles' class='info-titles'></div>
                    </div>

                    <div id='anno-container' class='info-container'>
                        <canvas id='anno-canvas' class='info-canvas'></canvas>
                        <div id='anno-titles' class='info-titles'></div>
                    </div>

                    <div id='button-container'>
                        <button onclick='left(ic, baf, logr);' class='icon'>
                            <span class='icon' id='arrow-left' title='Left'></span>
                        </button>
                        <button onclick='right(ic, baf, logr);' class='icon'>
                            <span class='icon' id='arrow-right' title='Right'></span>
                        </button>
                        <button onclick='zoomIn(ic, baf, logr);' class='icon'>
                            <span class='icon' id='search-plus' title='Zoom in'></span>
                        </button>
                        <button onclick='zoomOut(ic, baf, logr);' class='icon'>
                            <span class='icon' id='search-minus' title='Zoom out'></span>
                        </button>
                        <form id='region_form'>
                            <input onFocus='this.select();' id='region_field' type='text' size=20>
                            <input type='submit' title='Submit range'>
                        </form>
                    </div>

                    <div id='overview-container'>
                        <canvas id='overview-static'></canvas>
                    </div>
                </div>
            </div>
        </html>
    </head>

    <body>
        <script src='{{ url_for('static', filename='js/genecanvas.js') }}'></script>
        <script src='{{ url_for('static', filename='js/annotation.js') }}'></script>
        <script src='{{ url_for('static', filename='js/interactive.js') }}'></script>
        <script src='{{ url_for('static', filename='js/track.js') }}'></script>
        <script src='{{ url_for('static', filename='js/transcript.js') }}'></script>
        <script src='{{ url_for('static', filename='js/anno.js') }}'></script>
        <script src='{{ url_for('static', filename='js/overview.js') }}'></script>
        <script>

            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

            // FLASK VALUES //
            let sampleName = '{{ sample_name }}';
            let hgType = {{hg_type}}

            // WEBGL VALUES //
            let near = 0.1;
            let far = 100;
            let lineMargin = 2; // Margin for line thickness

            // Listener values
            let drag = false;
            let dragStart;
            let dragEnd;
            let inputField = document.getElementById('region_field');

            // Set first input field value for ic
            inputField.value = '{{chrom}}' + ':' + {{start}} + '-' + {{end}};
            inputField.placeholder = inputField.value;

            // BAF values
            let baf = {
                yStart: 1.0, // Start value for y axis
                yEnd: 0.0, // End value for y axis
                step: 0.2, // Step value for drawing ticks along y-axis
                color: '#000000' // Viz color
            };

            // LOGR values
            let logr = {
                yStart: 4.0, // Start value for y axis
                yEnd: -4.0, // End value for y axis
                step: 1.0, // Step value for drawing ticks along y-axis
                color: '#000000' // Viz color
            };

            // Hide non-rendered content
            window.onload = (event) => {
                document.getElementById('grid-container').style.visibility = 'hidden';
                document.title = '{{ sample_name }}'
            };

            // Reload page on window resize
            window.onresize = (event) => {
                window.location.reload(false);
            };

            // Initiate and draw interactive canvas
            let ic = new InteractiveCanvas(inputField, lineMargin, near, far,
                sampleName, hgType);
            ic.drawStaticContent(baf, logr);
            ic.drawInteractiveContent(baf, logr);

            // Initiate and draw track canvas
            let tc = new Transcript(ic.x, ic.plotWidth, near, far, hgType);
            tc.drawTracks(inputField.placeholder);

            // Initiate and draw annotation canvas
            let bc = new Anno(ic.x, ic.plotWidth, near, far);
            bc.drawTracks(inputField.placeholder);

            // Initiate and draw overview canvas
            let oc = new OverviewCanvas(ic.x, lineMargin, near, far,
                sampleName, hgType);
            oc.drawOverviewContent(baf, logr);

            // Initiate annotation canvas
            let ac = new Annotation(document.getElementById(
                        'visualization-container').clientHeight, sampleName);
            ic.loadAnnotations(ac, inputField.value);
            <!-- oc.loadAnnotations(ac); -->

            <!-- ic.contentCanvas.addEventListener('contextmenu', function(event) { -->
                <!-- event.preventDefault(); -->
            <!-- }, false); -->

            // Add annotation when content canvas is clicked
            oc.staticCanvas.addEventListener('contextmenu', function(event) {
                event.preventDefault();
                let annotOverlay = document.getElementById("annotation-overlays");
                // Do not add new annotations if it's hidden
                if (annotOverlay.style.visibility === "hidden") {
                    return;
                }

                <!-- let x = event.pageX - ac.annotationCanvas.offsetLeft; -->
                <!-- let y = event.pageY - ac.annotationCanvas.offsetTop; -->
                <!-- oc.insideGraph(x, y, ac.addAnnotation); -->
            }, false);

            oc.staticCanvas.addEventListener('mousemove', function (event) {
                if (ac.intersectsAnnotation(event.pageX - ac.annotationCanvas.offsetLeft,
                        event.pageY - ac.annotationCanvas.offsetTop, false)) {
                    oc.staticCanvas.style.cursor = 'pointer';
                } else {
                    oc.staticCanvas.style.cursor = 'default';
                }
            });

            oc.staticCanvas.addEventListener('mousedown', function (event) {
                // Only act on left mouse button click
                if (event.which != 1) {
                    return
                }

                ac.intersectsAnnotation(event.pageX - ac.annotationCanvas.offsetLeft,
                        event.pageY - ac.annotationCanvas.offsetTop, true);
            });

            window.addEventListener("beforeunload", function(e){
                ac.saveAnnotations();
            }, false);

            document.getElementById('region_form').addEventListener('submit',
                function (event) {
                event.preventDefault();
                ic.redraw(ac, baf, logr, inputField.value);
            });

            ic.contentCanvas.addEventListener('mousedown', function (event) {
                event.stopPropagation();
                switch (event.which) {
                    case 1: // Left mouse click
                        // Save annotations
                        ac.saveAnnotations();

                        // Do not move interactive canvas if an annotation is present
                        if (!ac.intersectsAnnotation(event.pageX - ac.annotationCanvas.offsetLeft,
                                event.pageY - ac.annotationCanvas.offsetTop, true)) {
                            if (!ic.disallowDrag) {
                                dragStart = {
                                    x: event.pageX - ic.contentCanvas.offsetLeft,
                                    y: event.pageY - ic.contentCanvas.offsetTop
                                };
                                dragEnd = {
                                    x: event.pageX - ic.contentCanvas.offsetLeft,
                                    y: event.pageY - ic.contentCanvas.offsetTop
                                };
                                drag = true;
                            }
                        }
                        break;
                    case 3: // Right click
                        ac.addingAnnot = false;
                        break;
                        let annotOverlay = document.getElementById("annotation-overlays");
                        // Do not add new annotations if it's hidden
                        if (annotOverlay.style.visibility === "hidden") {
                            return;
                        }

                        let x = event.pageX - ac.annotationCanvas.offsetLeft;
                        let y = event.pageY - ac.annotationCanvas.offsetTop;
                        if (ic.insideGraph(x, y)) {
                            ac.addingAnnot = true;
                            dragStart = {
                                x: x,
                                y: y
                            };
                            dragEnd = {
                                x: x,
                                y: y
                            };
                        } else {
                            ac.addingAnnot = false;
                        }
                }
            });

            ic.contentCanvas.addEventListener('mousemove', function (event) {
                event.preventDefault();
                event.stopPropagation();
                switch (event.which) {
                    case 1: // Left mouse click
                        if (ac.intersectsAnnotation(event.pageX - ac.annotationCanvas.offsetLeft,
                                event.pageY - ac.annotationCanvas.offsetTop, false)) {
                            ic.contentCanvas.style.cursor = 'pointer';
                        } else {
                            ic.contentCanvas.style.cursor = 'default';
                        }
                        if (drag && !ic.disallowDrag) {
                            dragEnd = {
                                x: event.pageX - ic.contentCanvas.offsetLeft,
                                y: event.pageY - ic.contentCanvas.offsetTop
                            };

                            // Hide interactive annotations
                            ac.ctx.clearRect(0, 0, ac.annotationCanvas.width, ic.contentCanvas.height);
                            let annotation = document.querySelectorAll("[data-type='interactive']");
                            for (let i = 0; i < annotation.length; i++) {
                                annotation[i].style.visibility = 'hidden';
                            }

                            // Clear whole content canvas
                            ic.contentCanvas.getContext('2d').clearRect(0,
                                ic.titleMargin / 2,
                                ic.contentCanvas.width,
                                ic.contentCanvas.height);

                            // Copy draw image to content Canvas
                            let lineMargin = 2;
                            ic.contentCanvas.getContext('2d').drawImage(ic.moveImg,
                                ic.extraWidth - (dragEnd.x - dragStart.x),
                                ic.y + lineMargin,
                                ic.plotWidth + 2 * ic.xMargin,
                                ic.canvasHeight,
                                ic.x,
                                ic.y + lineMargin,
                                ic.plotWidth + 2 * ic.xMargin,
                                ic.canvasHeight);
                        }
                        break;
                    case 3: // Right click
                        let annotOverlay = document.getElementById("annotation-overlays");
                        // Do not add new annotations if it's hidden
                        if (annotOverlay.style.visibility === "hidden") {
                            return;
                        }

                        let x = event.pageX - ac.annotationCanvas.offsetLeft;
                        let y = event.pageY - ac.annotationCanvas.offsetTop;
                        if (ac.addingAnnot && ic.insideGraph(x, y)) {
                            dragEnd = {
                                x: x,
                                y: y
                            };
                        }
                    break;
                }
            });

            ic.contentCanvas.addEventListener('mouseup', function (event) {
                event.preventDefault();
                event.stopPropagation();
                switch (event.which) {
                    case 1: // Left mouse click
                        if (drag) {
                            // Hide interactive annotations
                            ac.ctx.clearRect(0, 0, ac.annotationCanvas.width, ic.contentCanvas.height);
                            let annotation = document.querySelectorAll("[data-type='interactive']");
                            for (let i = 0; i < annotation.length; i++) {
                                annotation[i].style.visibility = 'visible';
                            }

                            drag = false;
                            let scale = ic.plotWidth / (ic.end - ic.start);
                            let moveDist = Math.floor((dragStart.x - dragEnd.x) / scale);

                            // Do not allow negative values
                            if (ic.start + moveDist < 0) {
                                moveDist -= (ic.start + moveDist);
                            }
                            ic.start += moveDist;
                            ic.end += moveDist;
                            ic.disallowDrag = true;

                            ic.redraw(ac, baf, logr, null);
                        }
                        break;
                    case 3: // Right click
                        let annotOverlay = document.getElementById("annotation-overlays");
                        // Do not add new annotations if it's hidden
                        if (annotOverlay.style.visibility === "hidden") {
                            return;
                        }

                        let x = event.pageX - ac.annotationCanvas.offsetLeft;
                        let y = event.pageY - ac.annotationCanvas.offsetTop;
                        if (ac.addingAnnot) {
                            if (ic.insideGraph(x, y)) {
                                dragEnd = {
                                    x: x,
                                    y: y
                                };
                            }
                            let width = Math.abs(dragEnd.x - dragStart.x);
                            let height = Math.abs(dragEnd.y - dragStart.y);
                            let x_pos = dragEnd.x - dragStart.x >= 0 ?
                                dragStart.x : dragEnd.x;
                            let y_pos = dragEnd.y - dragStart.y >= 0 ?
                                dragStart.y : dragEnd.y;
                            ac.ctx.clearRect(0, 0, ac.annotationCanvas.width, ic.canvasHeight);
                            ac.addAnnotation(x_pos, y_pos, width, height, '', ic, 'interactive');
                            ac.drawAnnotations();
                        }
                        setTimeout(function(){ac.addingAnnot = false;}, 10);
                    break;
                }
            });

            function keyMapper (options) {
                const keystrokeDelay = options.keystrokeDelay || 1000;

                let state = {
                    buffer: '',
                    lastKeyTime: Date.now()
                };

                document.addEventListener('keydown', event => {
                    const key = event.key;
                    const currentTime = Date.now();
                    const eventType = window.event;
                    const target = eventType.target || eventType.scrElement;
                    const targetTagName = (target.nodeType === 1) ? target.nodeName.toUpperCase() : '';
                    let buffer = '';

                    // Do not listen to keydown events for active fields
                    if (/INPUT|SELECT|TEXTAREA/.test(targetTagName)) {
                        return;
                    }

                    if (key === 'Enter' &&
                            currentTime - state.lastKeyTime < keystrokeDelay ||
                        key.toLowerCase() == 'x' || key.toLowerCase() == 'y') {
                        // Enter was pressed, process previous key presses.
                        if (key.toLowerCase() == 'x') {
                            ic.chromosome = 23;
                        } else if (key.toLowerCase() == 'y') {
                            ic.chromosome = 24;
                        } else if (state.buffer <= oc.numChrom && state.buffer > 0) {
                            ic.chromosome = state.buffer;
                        } else {
                            // No valid key pressed
                            return;
                        }
                        ic.redraw (ac, baf, logr, ic.chromosome + ':0-None');
                    } else if (!isFinite(key)) {
                        // Arrow keys for moving graph
                        switch (key) {
                        case 'ArrowLeft':
                            left(ic, baf, logr, sampleName);
                            break;
                        case 'ArrowRight':
                            right(ic, baf, logr, sampleName);
                            break;
                        case '+':
                            zoomIn(ic, baf, logr, sampleName);
                            break;
                        case '-':
                            zoomOut(ic, baf, logr, sampleName);
                            break;
                        default:
                            return;
                        }
                    } else if (currentTime - state.lastKeyTime > keystrokeDelay) {
                        // Reset buffer
                        buffer = key;
                    } else {
                        if (state.buffer.length > 1) {
                            // Buffer contains more than two digits, keep the last digit
                            buffer = state.buffer[state.buffer.length - 1] + key;
                        } else {
                            // Add new digit to buffer
                            buffer = state.buffer + key;
                        }
                    }
                    // Save current state
                    state = { buffer: buffer, lastKeyTime: currentTime };
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
                'use strict';

                const options = {
                    eventType: 'keydown',
                    keystrokeDelay: 1000
                };

                keyMapper(options);
            });
        </script>
    </body>
</html>
