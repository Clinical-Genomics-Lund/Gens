<!DOCTYPE html>
<html>
    <head>
		<meta charset=utf-8>
        <link rel="stylesheet" href="static/css/cov.css" type="text/css">
        <script src="{{ url_for('static', filename='js/jquery-3.1.1.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/three.min.js') }}"></script>
        <html>
            <div class="grid-container">
                <div id="interactive-container"></div>

                <div id="button-container">
                    <form id="region_form">
                        <input name="region" id='region_field' type="text" size=20>
                        <input type="submit">
                    </form>
                    <button onclick="left();">left</button>
                    <button onclick="right();">right</button>
                    <button onclick="zoomIn();">+</button>
                    <button onclick="zoomOut();">-</button>
                </div>

                <div id="overview-container">
                    <canvas id='overview-content'>
                    </canvas>
                    <canvas id='overview-text'>
                    </canvas>
                </div>
            </div>
        </html>
    </head>

    <body>
        <script type="text/javascript" src="{{ url_for('static', filename='js/cov.js')}}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='js/overview.js')}}"></script>

        <script>
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

            let logRMedian = {{median}};
            let title = "{{title}}";

            let callChrom = "{{call_chrom}}";
            let callStart = {{call_start}};
            let callEnd   = {{call_end}};

            var gc = new GeneCanvas(700, 300, "{{chrom}}", {{start}}, {{end}});
            var ctx = gc.dataCanvas.getContext("2d");

            <!-- OVERVIEW CANVAS -->

            <!-- let overviewWidth = 100; -->
            <!-- let overviewHeight = 400; -->
            <!-- let overviewNum = 0; -->

            <!-- let overviews = [overviewNum]; -->
            <!-- for (let i = 1; i <= overviewNum; i++) { -->
                <!-- overviews[i] = new OverviewCanvas(overviewWidth, overviewHeight, i); -->

                <!-- $.getJSON($SCRIPT_ROOT + '/_getcov', { -->
                    <!-- region: i + ":" + overviews[i].cvar.start + "-" + overviews[i].cvar.end, -->
                    <!-- median: logRMedian -->
                <!-- }, function(result) { -->
                    <!-- overviews[i].draw(result["data"], result["baf"]); -->
                <!-- }); -->
            <!-- } -->


            <!-- WEBGL OVERVIEW -->

            let width = $(document).innerWidth(), height = 800, near = 0.1, far = 100;
            let margin = 2;
            var scene = new THREE.Scene();
            var camera = new THREE.OrthographicCamera(width / -2, width / 2, height / -2, height / 2, near, far);

            // Set dimensions of overview canvases
            var canvas = document.getElementById('overview-content');
            canvas.width = width;
            canvas.height = height;
            document.getElementById('overview-text').width = width;
            document.getElementById('overview-text').height = height;

            var context = canvas.getContext('webgl2');
            var renderer = new THREE.WebGLRenderer({ canvas:canvas, context:context, antialiasing: true });


            var y_start = 0.0; // Start value for y axis
            var y_end = 1.0; // End value for y axis
            var step = 0.2; // Step value for drawing ticks along y-axis

            let x = margin * 2 + 20;
            let y = margin * 2;
            let num_chrom = 23;
            let y_pos = y;
            let chrom = 1;

            // TODO: draw both BAF and LOGR
            while (chrom < num_chrom) {
                for (let x_pos = x; x_pos + 120 < $(document).innerWidth(); x_pos += 120) {
                    createOverviewGraph(scene, chrom, x_pos, y_pos,  120, 120, y_start, y_end, step);
                    chrom++;
                }
                y_pos += 130;
            }
            <!-- createOverviewGraph(scene, x, y,  120, 120, y_start, y_end, step); -->
            <!-- createOverviewGraph(scene, 120 + margin * 2, y,  120, 120, y_start, y_end, step); -->

            camera.position.x = width / 2 - margin;
            camera.position.y = height / 2 - margin;
            camera.position.z = 1;

            function animate() {
                <!-- requestAnimationFrame( animate ); -->
                renderer.render( scene, camera );
            }
            animate();

            gc.draw({{data|safe}}, {{baf|safe}});


            <!-- LISTENERS -->

            var drag = false;
            var dragStart;
            var dragEnd;
            let input_field = document.getElementById('region_field');
            input_field.placeholder = gc.cvar.chromosome + ':' + gc.cvar.start + '-' + gc.cvar.end;

            document.getElementById('region_form').addEventListener('submit', function (event) {
                event.preventDefault();
                $.getJSON($SCRIPT_ROOT + '/_getcov', {
                    region: document.getElementById('region_field').value,
                    median: logRMedian
                }, function (result) {
                    gc.cvar.chromosome = result['chrom'];
                    gc.cvar.start = result['start'];
                    gc.cvar.end = result['end'];
                    gc.draw(result['data'], result['baf']);
                }).done(function () {
                    input_field.blur();
                }).fail(function () {
                    console.log("Bad input");
                    input_field.placeholder = 'Bad input: ' + input_field.value;
                    input_field.value = '';
                });
            });

            gc.dataCanvas.addEventListener('mousedown', function(event) {
                if (!gc.cvar.disallowDrag) {
                    dragStart = {
                        x: event.pageX - gc.dataCanvas.offsetLeft,
                        y: event.pageY - gc.dataCanvas.offsetTop
                    }
                    dragEnd = {
                        x: event.pageX - gc.dataCanvas.offsetLeft,
                        y: event.pageY - gc.dataCanvas.offsetTop
                    }
                    drag = true;
                }
            });

            gc.dataCanvas.addEventListener('mousemove', function(event) {
                if (drag && !gc.cvar.disallowDrag) {
                    dragEnd = {
                        x: event.pageX - gc.dataCanvas.offsetLeft,
                        y: event.pageY - gc.dataCanvas.offsetTop
                    }
                    ctx.clearRect(0, 0, gc.dataCanvas.width, gc.dataCanvas.height);
                    ctx.drawImage(gc.drawCanvas,
                                0,
                                0,
                                gc.drawCanvas.width,
                                gc.drawCanvas.height,
                                dragEnd.x - dragStart.x,
                                0,
                                gc.drawCanvas.width,
                                gc.drawCanvas.height);
                }
            });

            gc.dataCanvas.addEventListener('mouseup', function(event) {
                if (drag) {
                    drag = false;
                    let scale = gc.dataCanvas.width / (gc.cvar.end - gc.cvar.start);
                    let move_dist = Math.floor((dragStart.x - dragEnd.x) / scale);
                    if (gc.cvar.start + move_dist < 0 ) {
                        move_dist -= (gc.cvar.start + move_dist);
                    }
                    gc.cvar.start += move_dist;
                    gc.cvar.end += move_dist;
                    gc.cvar.disallowDrag = true;
                    redraw();
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                'use strict';

                const options = {
                    eventType: 'keydown',
                    keystrokeDelay: 1000
                };

                keyMapper(options);
            });
        </script>
    </body>
</html>
