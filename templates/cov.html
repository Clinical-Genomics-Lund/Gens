<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <link rel='stylesheet' href='static/css/cov.css' type='text/css'>
        <script src='https://use.fontawesome.com/releases/v5.10.2/js/all.js' data-auto-replace-svg='nest'></script>
        <link rel='icon' href='data:,'>
        <script src='{{ url_for('static', filename='js/jquery-3.1.1.min.js') }}'></script>
        <script src='{{ url_for('static', filename='js/three.min.js') }}'></script>
        <html>
            <div id='progress-container'>
                <progress value="0" max="1" id='progress-bar'></progress>
            </div>

            <div id='grid-container'>
                <div id='interactive-container'>
                    <canvas id='interactive-content'></canvas>
                    <canvas id='interactive-static'></canvas>
                </div>

                <div id='button-container'>
                    <button onclick='left();'>
                        <span class='fas fa-arrow-left' title='Left'></span>
                    </button>
                    <button onclick='right();'>
                        <span class='fas fa-arrow-right' title='Right'></span>
                    </button>
                    <button onclick='zoomIn();'>
                        <span class='fas fa-search-plus' title='Zoom in'></span>
                    </button>
                    <button onclick='zoomOut();'>
                        <span class='fas fa-search-minus' title='Zoom out'></span>
                    </button>
                    <form id='region_form'>
                        <input name='region' id='region_field' type='text' size=20>
                        <input type='submit' title='Submit range'>
                    </form>
                </div>

                <div id='overview-container'>
                    <canvas id='overview-static'></canvas>
                </div>
            </div>
        </html>
    </head>

    <body>
        <script type='module'>
            import { InteractiveCanvas } from '{{ url_for('modules', filename='/interactive.mjs') }}';
            import { OverviewCanvas } from '{{ url_for('modules', filename='/overview.mjs') }}';

            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

            // FLASK VALUES //
            let logRMedian = {{ median }};
            let title = '{{ title }}';

            let callChrom = '{{ call_chrom }}';
            let callStart = {{ call_start }};
            let callEnd   = {{ call_end }};

            // WEBGL VALUES //
            let near = 0.1;
            let far = 100;
            let lineMargin = 2; // Margin for line thickness

            // Listener values
            let drag = false;
            let dragStart;
            let dragEnd;
            let inputField = document.getElementById('region_field');

            // BAF values
            let baf = {
                yStart: 1.0, // Start value for y axis
                yEnd: 0.0, // End value for y axis
                step: 0.2 // Step value for drawing ticks along y-axis
            };

            // LOGR values
            let logr = {
                yStart: 4.0, // Start value for y axis
                yEnd: -4.0, // End value for y axis
                step: 1.0 // Step value for drawing ticks along y-axis
            };


            // Hide non-rendered content
            window.onload = (event) => {
                document.getElementById('grid-container').style.visibility = 'hidden';
            };

            // Set first input field value for ic
            document.getElementById('region_field').placeholder = '1:100000-200000';

            // Initiate and draw interactive canvas
            let ic = InteractiveCanvas(inputField, lineMargin, near, far);
            ic.drawStaticContent(baf, logr);
            ic.drawInteractiveContent(baf, logr, logRMedian);

            // Adjust canvas margins to compensate for extra hidden data
            let adjustedMargin = Math.min(0, $(document).innerWidth() - ic.width) / 2;
            document.getElementById('interactive-container').style.marginLeft =
                adjustedMargin + 'px';
            document.getElementById('overview-container').style.marginLeft =
                adjustedMargin + 'px';

            // Initiate and draw overview canvas
            let oc = OverviewCanvas(ic.x, lineMargin, adjustedMargin, near, far);
            oc.drawOverviewContent(baf, logr, logRMedian);

            // LISTENERS
            document.getElementById('region_form').addEventListener('submit',
                function (event) {
                event.preventDefault();
                ic.drawInteractiveContent(baf, logr);
                });

            ic.contentCanvas.addEventListener('mousedown', function (event) {
                ic.moveImg = ic.contentCanvas.getContext('2d').getImageData(
                0, ic.y + 2, ic.width, ic.height);
                if (!ic.disallowDrag) {
                dragStart = {
                    x: event.pageX - ic.contentCanvas.offsetLeft,
                    y: event.pageY - ic.contentCanvas.offsetTop
                };
                dragEnd = {
                    x: event.pageX - ic.contentCanvas.offsetLeft,
                    y: event.pageY - ic.contentCanvas.offsetTop
                };
                drag = true;
                }
            });

            ic.contentCanvas.addEventListener('mousemove', function (event) {
                if (drag && !ic.disallowDrag) {
                dragEnd = {
                    x: event.pageX - ic.contentCanvas.offsetLeft,
                    y: event.pageY - ic.contentCanvas.offsetTop
                };

                // Clear whole content canvas
                ic.contentCanvas.getContext('2d').clearRect(0, ic.titleMargin / 2,
                    ic.contentCanvas.width, ic.contentCanvas.height);

                // Copy draw image to content Canvas
                ic.contentCanvas.getContext('2d').putImageData(
                    ic.moveImg,
                    dragEnd.x - dragStart.x,
                    ic.y + 2);
                }
            });

            ic.contentCanvas.addEventListener('mouseup', function (event) {
                if (drag) {
                ic.moveImg = null;
                drag = false;
                let scale = ic.boxWidth / (ic.end - ic.start);
                let moveDist = Math.floor((dragStart.x - dragEnd.x) / scale);
                if (ic.start + moveDist < 0) {
                    moveDist -= (ic.start + moveDist);
                }
                ic.start += moveDist;
                ic.end += moveDist;
                ic.disallowDrag = true;
                ic.redraw();
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                'use strict';

                const options = {
                eventType: 'keydown',
                keystrokeDelay: 1000
                };

                ic.keyMapper(options);
            });
        </script>
    </body>
</html>
