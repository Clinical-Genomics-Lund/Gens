<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <link rel="stylesheet" href="static/css/cov.css" type="text/css">
        <script src="https://use.fontawesome.com/releases/v5.10.2/js/all.js" data-auto-replace-svg="nest"></script>
        <link rel="icon" href="data:,">
        <script src="{{ url_for('static', filename='js/jquery-3.1.1.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/three.min.js') }}"></script>
        <html>
            <div class="grid-container">
                <div id="interactive-container">
                    <canvas id='interactive-content'></canvas>
                    <canvas id='interactive-static'></canvas>
                </div>

                <div id="button-container">
                    <button onclick="left();">
                        <span class="fas fa-arrow-left" title='Left'></span>
                    </button>
                    <button onclick="right();">
                        <span class="fas fa-arrow-right" title='Right'></span>
                    </button>
                    <button onclick="zoomIn();">
                        <span class="fas fa-search-plus" title='Zoom in'></span>
                    </button>
                    <button onclick="zoomOut();">
                        <span class="fas fa-search-minus" title='Zoom out'></span>
                    </button>
                    <form id="region_form">
                        <input name='region' id='region_field' type='text' size=20>
                        <input type='submit' title='Submit range'>
                    </form>
                </div>

                <div id="overview-container">
                    <canvas id='overview-static'></canvas>
                </div>
            </div>
        </html>
    </head>

    <body>
        <script type="text/javascript" src="{{ url_for('static', filename='js/overview.js')}}"></script>

        <script>
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

            // FLASK VALUES //
            let logRMedian = {{ median }};
            let title = "{{ title }}";

            let callChrom = "{{ call_chrom }}";
            let callStart = {{ call_start }};
            let callEnd   = {{ call_end }};

            // WEBGL VALUES //
            let near = 0.1;
            let far = 100;
            let lineMargin = 2; // Margin for line thickness

            // BAF values
            let baf = {
                yStart: 1.0, // Start value for y axis
                yEnd: 0.0, // End value for y axis
                step: 0.2 // Step value for drawing ticks along y-axis
            };

            // LOGR values
            let logr = {
                yStart: 4.0, // Start value for y axis
                yEnd: -4.0, // End value for y axis
                step: 1.0 // Step value for drawing ticks along y-axis
            };

            // Overview canvas values
            // The null-values are set later since they use values set here
            let oc = {
                // Canvases
                contentCanvas: null,
                staticCanvas: document.getElementById('overview-static'),
                context: null,

                // Canvas variables
                width: $(document).innerWidth(), // Canvas width
                height: 800, // Canvas height
                resStart: 0, // Start value for overview graph
                resEnd: 245000000, // End value for overview graph

                // Box variables
                boxWidth: 120, // Width of one box
                boxHeight: 130, // Height of one box
                x: null, // X-position for box
                y: 20, // Y-position for box
                numChrom: 1, // Number of displayable chromosomes
                rowMargin: 30, // margin between rows
                titleMargin: 10, // Margin between box and title
                xMargin: 2, // margin for x-axis in graph
                yMargin: 5, // margin for top and bottom in graph
                leftmostPoint: 28, // Draw y-values for graph left of this point
                xAmpl: null, // Part of amplitude for scaling x-axis to fill whole width

                // WebGL scene variables
                scene: new THREE.Scene(),
                camera: null,
                renderer: null
            };

            // Set dimensions of overview canvases
            oc.staticCanvas.width = oc.width;
            oc.staticCanvas.height = oc.height;

            // Set null values
            oc.contentCanvas = new OffscreenCanvas(oc.width, oc.height);
            oc.context = oc.contentCanvas.getContext('webgl2');
            oc.camera = new THREE.OrthographicCamera(oc.width / -2, oc.width / 2, oc.height / -2, oc.height / 2, near, far);
            oc.renderer = new THREE.WebGLRenderer({ canvas: oc.contentCanvas,
                context: oc.context, antialiasing: true });
            oc.x = lineMargin * 2 + 20;
            oc.y = lineMargin * 2;
            oc.xAmpl = oc.boxWidth - 2 * oc.xMargin;

            // Interactive canvas values
            // The null-values are set later since they use values set here
            let ic = {
                // Canvases
                drawCanvas: null,
                contentCanvas: document.getElementById('interactive-content'),
                staticCanvas: document.getElementById('interactive-static'),
                context: null,

                // Canvas variables
                width: $(document).innerWidth(), // Canvas width
                height: 470, // Canvas height

                // Box variables
                boxWidth: 600, // Width of one box
                boxHeight: 200, // Height of one box
                x: null, // X-position for first box
                y: null, // Y-position for first box
                titleMargin: 50, // Margin between box and title
                legendMargin: 45, // Margin between legend and box
                xMargin: 2, // margin for x-axis in graph
                yMargin: 5, // margin for top and bottom in graph
                xAmpl: null, // Part of amplitude for scaling x-axis to fill whole box width
                extraWidth: 200, // Width for loading in extra edge data

                // Data values
                chromosome: null,
                start: null,
                end: null,
                disallowDrag: false,

                // WebGL scene variables
                scene: new THREE.Scene(),
                camera: null,
                renderer: null
            };

            // Set dimensions of overview canvases
            ic.staticCanvas.width = ic.width;
            ic.staticCanvas.height = ic.height;
            ic.contentCanvas.width = ic.width;
            ic.contentCanvas.height = ic.height;

            ic.staticCanvas.getContext('2d').clearRect(0, 0, ic.width, ic.height);

            // Set null values
            ic.drawCanvas = new OffscreenCanvas(ic.width, ic.height);
            ic.context = ic.drawCanvas.getContext('webgl2');
            ic.camera = new THREE.OrthographicCamera(ic.width / -2, ic.width / 2, ic.height / -2, ic.height / 2, near, far);
            ic.renderer = new THREE.WebGLRenderer({ canvas: ic.drawCanvas, context: ic.context, antialiasing: true });
            ic.x = ic.width / 2 - ic.boxWidth / 2;
            ic.y = 10 + lineMargin * 2 + ic.titleMargin;
            ic.xAmpl = ic.boxWidth - 2 * ic.xMargin;

            // Listener values
            var drag = false;
            var dragStart;
            var dragEnd;
            let inputField = document.getElementById('region_field');

            // Set first input field value for ic
            document.getElementById('region_field').placeholder = '1:100000-200000';

            // Only want to see fourth quadrant of scene
            oc.camera.position.x = oc.width / 2 - lineMargin;
            oc.camera.position.y = oc.height / 2 - lineMargin;
            oc.camera.position.z = 1;
            ic.camera.position.x = ic.width / 2 - lineMargin;
            ic.camera.position.y = ic.height / 2 - lineMargin;
            ic.camera.position.z = 1;

            // Draw interactive canvas
            drawStaticContent();
            drawInteractiveContent();

            let chrom = 1; // First chromosome
            let drawnChrom = 0; // Amount of async drawn chromosomes
            let yPos = oc.y + oc.rowMargin;
            while (chrom <= oc.numChrom) {
                // Fill row with graphs, start on new row when full
                for (let xPos = oc.x; (xPos + oc.boxWidth < $(document).innerWidth()) && (chrom <= oc.numChrom); xPos += oc.boxWidth) {
                    // Draw data
                    $.getJSON($SCRIPT_ROOT + '/_getoverviewcov', {
                        region: chrom + ':' + oc.resStart + '-' + oc.resEnd,
                        median: logRMedian,
                        xpos: xPos + oc.xMargin,
                        ypos: yPos,
                        boxHeight: oc.boxHeight,
                        y_margin: oc.yMargin,
                        x_ampl: oc.xAmpl
                    }, function (result) {
                        let staticCanvas = document.getElementById('overview-static');
                        // Draw chromosome title
                        drawText(staticCanvas,
                                result['x_pos'] - oc.xMargin + oc.boxWidth / 2,
                                result['y_pos'] - oc.titleMargin,
                                result['chrom'], 10, 'center');

                        // Draw BAF
                        createGraph(oc.scene, staticCanvas,
                                result['x_pos'] - oc.xMargin,
                                result['y_pos'], oc.boxWidth, oc.boxHeight, oc.yMargin,
                                baf.yStart, baf.yEnd, baf.step,
                                result['x_pos'] < oc.leftmostPoint);

                        // Draw LogR
                        createGraph(oc.scene, staticCanvas,
                                result['x_pos'] - oc.xMargin,
                                result['y_pos'] + oc.boxHeight, oc.boxWidth,
                                oc.boxHeight, oc.yMargin, logr.yStart,
                                logr.yEnd, logr.step,
                                result['x_pos'] < oc.leftmostPoint);

                        // Plot scatter data
                        drawData(oc.scene, result['baf'], '#FF0000');
                        drawData(oc.scene, result['data'], '#000000');

                        if (++drawnChrom == oc.numChrom) {
                            // Render scene and transfer to visible canvas
                            oc.renderer.render(oc.scene, oc.camera);
                            oc.staticCanvas.getContext('2d').drawImage(oc.contentCanvas.transferToImageBitmap(), 0, 0);
                        }
                    });
                    chrom++;
                }
                // Start on new row
                yPos += 2 * oc.boxHeight + oc.rowMargin;
            }

            // Only want to see fourth quadrant
            oc.camera.position.x = oc.width / 2 - lineMargin;
            oc.camera.position.y = oc.height / 2 - lineMargin;
            oc.camera.position.z = 1;
            ic.camera.position.x = ic.width / 2 - lineMargin;
            ic.camera.position.y = ic.height / 2 - lineMargin;
            ic.camera.position.z = 1;

            // LISTENERS

            document.getElementById('region_form').addEventListener('submit',
                    function (event) {
                event.preventDefault();
                drawInteractiveContent();
            });

            ic.contentCanvas.addEventListener('mousedown', function (event) {
                if (!ic.disallowDrag) {
                    dragStart = {
                        x: event.pageX - ic.contentCanvas.offsetLeft,
                        y: event.pageY - ic.contentCanvas.offsetTop
                    };
                    dragEnd = {
                        x: event.pageX - ic.contentCanvas.offsetLeft,
                        y: event.pageY - ic.contentCanvas.offsetTop
                    };
                    drag = true;
                }
            });

            ic.contentCanvas.addEventListener('mousemove', function (event) {
                if (drag && !ic.disallowDrag) {
                    dragEnd = {
                        x: event.pageX - ic.contentCanvas.offsetLeft,
                        y: event.pageY - ic.contentCanvas.offsetTop
                    };

                    ic.contentCanvas.getContext('2d').clearRect(0, 0,
                            ic.contentCanvas.width, ic.contentCanvas.height);
                    ic.contentCanvas.getContext('2d').drawImage(
                            ic.drawCanvas,
                            0,
                            0,
                            ic.contentCanvas.width,
                            ic.contentCanvas.height,
                            dragEnd.x - dragStart.x,
                            0,
                            ic.contentCanvas.width,
                            ic.contentCanvas.height);
                }
            });

            ic.contentCanvas.addEventListener('mouseup', function (event) {
                if (drag) {
                    drag = false;
                    let scale = ic.contentCanvas.width / (ic.end - ic.start);
                    let moveDist = Math.floor((dragStart.x - dragEnd.x) / scale);
                    if (ic.start + moveDist < 0) {
                        moveDist -= (ic.start + moveDist);
                    }
                    ic.start += moveDist;
                    ic.end += moveDist;
                    ic.disallowDrag = true;
                    redraw();
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                'use strict';

                const options = {
                    eventType: 'keydown',
                    keystrokeDelay: 1000
                };

                keyMapper(options);
            });
        </script>
    </body>
</html>
